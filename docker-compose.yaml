version: "3"

services:
  compose-dashboard:
    image: "mcr.microsoft.com/dotnet/nightly/aspire-dashboard:latest"
    environment:
      ASPIRE_DASHBOARD_FORWARDEDHEADERS_ENABLED: "true"
    ports:
      - "18888"
    expose:
      - "18889"
      - "18890"
    networks:
      - "dokploy-network"
    restart: "always"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard-router.entrypoints=websecure"
      - "traefik.http.routers.dashboard-router.rule=Host(`dashboard.emma.antoniobermudez.dev`)"
      - "traefik.http.routers.dashboard-router.tls=true"
      - "traefik.http.routers.dashboard-router.tls.certresolver=letsencrypt"
      - "traefik.http.routers.dashboard-router.service=dashboard-svc"
      - "traefik.http.services.dashboard-svc.loadbalancer.server.port=18888"

  postgresql:
    image: "docker.io/timescale/timescaledb:latest-pg17"
    environment:
      POSTGRES_HOST_AUTH_METHOD: "scram-sha-256"
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256 --auth-local=scram-sha-256"
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "${POSTGRESQL_PASSWORD}"
      POSTGRES_DB: "postgres"
    volumes:
      - ../files/init-db:/docker-entrypoint-initdb.d
      - postgres_data:/var/lib/postgresql/data
    expose:
      - "5432"
    networks:
      - "dokploy-network"

  messaging:
    image: "docker.io/confluentinc/confluent-local:8.1.0"
    environment:
      KAFKA_LISTENERS: "PLAINTEXT://0.0.0.0:29092,CONTROLLER://0.0.0.0:29093,PLAINTEXT_HOST://0.0.0.0:9092,PLAINTEXT_INTERNAL://0.0.0.0:9093"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT,PLAINTEXT_INTERNAL:PLAINTEXT"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://messaging:29092,PLAINTEXT_HOST://messaging:9092,PLAINTEXT_INTERNAL://messaging:9093"
    expose:
      - "9092"
      - "9093"
    networks:
      - "dokploy-network"

  mqtt-bridge:
    image: "${MQTT_BRIDGE_IMAGE}"
    environment:
      ConnectionStrings__messaging: "messaging:9092"
      MESSAGING_HOST: "messaging"
      MESSAGING_PORT: "9092"
      KAFKA_BROKERS: "messaging:9093"
      KAFKA_TOPIC: "telemetry-raw"
    expose:
      - "1883"
    depends_on:
      messaging:
        condition: "service_started"
    networks:
      - "dokploy-network"

  energy-simulator:
    image: "${ENERGY_SIMULATOR_IMAGE}"
    environment:
      OTEL_TRACES_EXPORTER: "otlp"
      OTEL_LOGS_EXPORTER: "otlp"
      OTEL_METRICS_EXPORTER: "otlp"
      OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED: "true"
      MQTT_BROKER_URL: "tcp://mqtt-bridge:1883"
      TENANT_ID: "T001"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://compose-dashboard:18889"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_SERVICE_NAME: "energy-simulator"
    depends_on:
      mqtt-bridge:
        condition: "service_started"
    networks:
      - "dokploy-network"

  server:
    image: "${SERVER_IMAGE}"
    environment:
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EXCEPTION_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EVENT_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_RETRY: "in_memory"
      ASPNETCORE_FORWARDEDHEADERS_ENABLED: "true"
      HTTP_PORTS: "5000"
      ConnectionStrings__app-db: "Host=postgresql;Port=5432;Username=postgres;Password=${POSTGRESQL_PASSWORD};Database=app-db"
      ConnectionStrings__telemetry-db: "Host=postgresql;Port=5432;Username=postgres;Password=${POSTGRESQL_PASSWORD};Database=telemetry-db"
      Jwt__Key: "${JWT_KEY}"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://compose-dashboard:18889"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_SERVICE_NAME: "server"
    depends_on:
      postgresql:
        condition: "service_started"
    networks:
      - "dokploy-network"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.server-router.entrypoints=websecure"
      - "traefik.http.routers.server-router.rule=Host(`server.emma.antoniobermudez.dev`)"
      - "traefik.http.routers.server-router.tls=true"
      - "traefik.http.routers.server-router.tls.certresolver=letsencrypt"
      - "traefik.http.routers.server-router.service=server-svc"
      - "traefik.http.services.server-svc.loadbalancer.server.port=5000"

  market-service:
    image: "${MARKET_SERVICE_IMAGE}"
    environment:
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EXCEPTION_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EVENT_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_RETRY: "in_memory"
      ConnectionStrings__messaging: "messaging:9092"
      MESSAGING_HOST: "messaging"
      MESSAGING_PORT: "9092"
      ConnectionStrings__telemetry-db: "Host=postgresql;Port=5432;Username=postgres;Password=${POSTGRESQL_PASSWORD};Database=telemetry-db"
      TELEMETRY_DB_HOST: "postgresql"
      TELEMETRY_DB_PORT: "5432"
      TELEMETRY_DB_USERNAME: "postgres"
      TELEMETRY_DB_PASSWORD: "${POSTGRESQL_PASSWORD}"
      TELEMETRY_DB_URI: "postgresql://postgres:${POSTGRESQL_PASSWORD}@postgresql:5432/telemetry-db"
      TELEMETRY_DB_JDBCCONNECTIONSTRING: "jdbc:postgresql://postgresql:5432/telemetry-db"
      TELEMETRY_DB_DATABASENAME: "telemetry-db"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://compose-dashboard:18889"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_SERVICE_NAME: "market-service"
    depends_on:
      messaging:
        condition: "service_started"
      server:
        condition: "service_started"
    networks:
      - "dokploy-network"

  ingestion:
    image: "${INGESTION_IMAGE}"
    environment:
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EXCEPTION_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EVENT_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_RETRY: "in_memory"
      ConnectionStrings__app-db: "Host=postgresql;Port=5432;Username=postgres;Password=${POSTGRESQL_PASSWORD};Database=app-db"
      APP_DB_HOST: "postgresql"
      APP_DB_PORT: "5432"
      APP_DB_USERNAME: "postgres"
      APP_DB_PASSWORD: "${POSTGRESQL_PASSWORD}"
      APP_DB_URI: "postgresql://postgres:${POSTGRESQL_PASSWORD}@postgresql:5432/app-db"
      APP_DB_JDBCCONNECTIONSTRING: "jdbc:postgresql://postgresql:5432/app-db"
      APP_DB_DATABASENAME: "app-db"
      ConnectionStrings__telemetry-db: "Host=postgresql;Port=5432;Username=postgres;Password=${POSTGRESQL_PASSWORD};Database=telemetry-db"
      TELEMETRY_DB_HOST: "postgresql"
      TELEMETRY_DB_PORT: "5432"
      TELEMETRY_DB_USERNAME: "postgres"
      TELEMETRY_DB_PASSWORD: "${POSTGRESQL_PASSWORD}"
      TELEMETRY_DB_URI: "postgresql://postgres:${POSTGRESQL_PASSWORD}@postgresql:5432/telemetry-db"
      TELEMETRY_DB_JDBCCONNECTIONSTRING: "jdbc:postgresql://postgresql:5432/telemetry-db"
      TELEMETRY_DB_DATABASENAME: "telemetry-db"
      ConnectionStrings__messaging: "messaging:9092"
      MESSAGING_HOST: "messaging"
      MESSAGING_PORT: "9092"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://compose-dashboard:18889"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_SERVICE_NAME: "ingestion"
    depends_on:
      postgresql:
        condition: "service_started"
      messaging:
        condition: "service_started"
      server:
        condition: "service_started"
    networks:
      - "dokploy-network"

  emma-identity:
    image: "${EMMA_IDENTITY_IMAGE}"
    environment:
      HTTP_PORTS: "5001"
      ASPNETCORE_FORWARDEDHEADERS_ENABLED: "true"
      ConnectionStrings__identity-db: "Host=postgresql;Port=5432;Username=postgres;Password=${POSTGRESQL_PASSWORD};Database=identity-db"
      Jwt__Key: "${JWT_KEY}"
      Jwt__Issuer: "emma-identity"
      Jwt__Audience: "emma-api"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://compose-dashboard:18889"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_SERVICE_NAME: "emma-identity"
    depends_on:
      postgresql:
        condition: "service_started"
    networks:
      - "dokploy-network"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.identity-router.entrypoints=websecure"
      - "traefik.http.routers.identity-router.rule=Host(`auth.emma.antoniobermudez.dev`)"
      - "traefik.http.routers.identity-router.tls=true"
      - "traefik.http.routers.identity-router.tls.certresolver=letsencrypt"
      - "traefik.http.routers.identity-router.service=identity-svc"
      - "traefik.http.services.identity-svc.loadbalancer.server.port=5001"

  webfrontend:
    image: "${WEBFRONTEND_IMAGE}"
    environment:
      NODE_ENV: "production"
      PORT: "8000"
      SERVER_HTTP: "http://server:5000"
      EMMA_IDENTITY_HTTP: "http://emma-identity:5001"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://compose-dashboard:18889"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_SERVICE_NAME: "webfrontend"
    depends_on:
      server:
        condition: "service_started"
    networks:
      - "dokploy-network"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend-router.entrypoints=websecure"
      - "traefik.http.routers.frontend-router.rule=Host(`app.emma.antoniobermudez.dev`)"
      - "traefik.http.routers.frontend-router.tls=true"
      - "traefik.http.routers.frontend-router.tls.certresolver=letsencrypt"
      - "traefik.http.routers.frontend-router.service=frontend-svc"
      - "traefik.http.services.frontend-svc.loadbalancer.server.port=80"

  command-service:
    image: "${COMMAND_SERVICE_IMAGE}"
    environment:
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EXCEPTION_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EVENT_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_RETRY: "in_memory"
      ConnectionStrings__messaging: "messaging:9092"
      MESSAGING_HOST: "messaging"
      MESSAGING_PORT: "9092"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://compose-dashboard:18889"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_SERVICE_NAME: "command-service"
    depends_on:
      messaging:
        condition: "service_started"
    networks:
      - "dokploy-network"

  emma-api:
    image: "${EMMA_API_IMAGE}"
    environment:
      ASPNETCORE_FORWARDEDHEADERS_ENABLED: "true"
      HTTP_PORTS: "5002"
      ConnectionStrings__identity-db: "Host=postgresql;Port=5432;Username=postgres;Password=${POSTGRESQL_PASSWORD};Database=identity-db"
      Jwt__Key: "${JWT_KEY}"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://compose-dashboard:18889"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_SERVICE_NAME: "emma-api"
    depends_on:
      postgresql:
        condition: "service_started"
    networks:
      - "dokploy-network"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api-router.entrypoints=websecure"
      - "traefik.http.routers.api-router.rule=Host(`api.emma.antoniobermudez.dev`)"
      - "traefik.http.routers.api-router.tls=true"
      - "traefik.http.routers.api-router.tls.certresolver=letsencrypt"
      - "traefik.http.routers.api-router.service=api-svc"
      - "traefik.http.services.api-svc.loadbalancer.server.port=5002"

  solar-forecaster:
    image: "${SOLAR_FORECASTER_IMAGE}"
    environment:
      OTEL_TRACES_EXPORTER: "otlp"
      OTEL_LOGS_EXPORTER: "otlp"
      OTEL_METRICS_EXPORTER: "otlp"
      OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED: "true"
      ConnectionStrings__telemetry-db: "Host=postgresql;Port=5432;Username=postgres;Password=${POSTGRESQL_PASSWORD};Database=telemetry-db"
      TELEMETRY_DB_HOST: "postgresql"
      TELEMETRY_DB_PORT: "5432"
      TELEMETRY_DB_USERNAME: "postgres"
      TELEMETRY_DB_PASSWORD: "${POSTGRESQL_PASSWORD}"
      TELEMETRY_DB_URI: "postgresql://postgres:${POSTGRESQL_PASSWORD}@postgresql:5432/telemetry-db"
      TELEMETRY_DB_JDBCCONNECTIONSTRING: "jdbc:postgresql://postgresql:5432/telemetry-db"
      TELEMETRY_DB_DATABASENAME: "telemetry-db"
      ConnectionStrings__messaging: "messaging:9092"
      MESSAGING_HOST: "messaging"
      MESSAGING_PORT: "9092"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://compose-dashboard:18889"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_SERVICE_NAME: "solar-forecaster"
    depends_on:
      postgresql:
        condition: "service_started"
    networks:
      - "dokploy-network"

  optimizer:
    image: "${OPTIMIZER_IMAGE}"
    environment:
      OTEL_TRACES_EXPORTER: "otlp"
      OTEL_LOGS_EXPORTER: "otlp"
      OTEL_METRICS_EXPORTER: "otlp"
      OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED: "true"
      ConnectionStrings__telemetry-db: "Host=postgresql;Port=5432;Username=postgres;Password=${POSTGRESQL_PASSWORD};Database=telemetry-db"
      TELEMETRY_DB_HOST: "postgresql"
      TELEMETRY_DB_PORT: "5432"
      TELEMETRY_DB_USERNAME: "postgres"
      TELEMETRY_DB_PASSWORD: "${POSTGRESQL_PASSWORD}"
      TELEMETRY_DB_URI: "postgresql://postgres:${POSTGRESQL_PASSWORD}@postgresql:5432/telemetry-db"
      TELEMETRY_DB_JDBCCONNECTIONSTRING: "jdbc:postgresql://postgresql:5432/telemetry-db"
      TELEMETRY_DB_DATABASENAME: "telemetry-db"
      ConnectionStrings__messaging: "messaging:9092"
      MESSAGING_HOST: "messaging"
      MESSAGING_PORT: "9092"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://compose-dashboard:18889"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_SERVICE_NAME: "optimizer"
    depends_on:
      postgresql:
        condition: "service_started"
      solar-forecaster:
        condition: "service_started"
    networks:
      - "dokploy-network"

volumes:
  postgres_data:

networks:
  dokploy-network:
    external: true