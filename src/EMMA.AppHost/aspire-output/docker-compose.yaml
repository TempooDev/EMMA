services:
  compose-dashboard:
    image: "mcr.microsoft.com/dotnet/nightly/aspire-dashboard:latest"
    environment:
      ASPIRE_DASHBOARD_FORWARDEDHEADERS_ENABLED: "true"
    ports:
      - "8080:18888"
    expose:
      - "18889"
      - "18890"
    networks:
      - "aspire"
    restart: "always"
  postgresql:
    image: "docker.io/timescale/timescaledb:latest-pg17"
    environment:
      POSTGRES_HOST_AUTH_METHOD: "scram-sha-256"
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256 --auth-local=scram-sha-256"
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "${POSTGRESQL_PASSWORD}"
    expose:
      - "5432"
    networks:
      - "aspire"
  messaging:
    image: "docker.io/confluentinc/confluent-local:8.1.0"
    environment:
      KAFKA_LISTENERS: "PLAINTEXT://localhost:29092,CONTROLLER://localhost:29093,PLAINTEXT_HOST://0.0.0.0:9092,PLAINTEXT_INTERNAL://0.0.0.0:9093"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT,PLAINTEXT_INTERNAL:PLAINTEXT"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://messaging:29092,PLAINTEXT_HOST://messaging:9092,PLAINTEXT_INTERNAL://messaging:9093"
    expose:
      - "9092"
      - "9093"
    networks:
      - "aspire"
  mqtt-bridge:
    image: "${MQTT_BRIDGE_IMAGE}"
    environment:
      ConnectionStrings__messaging: "messaging:9092"
      MESSAGING_HOST: "messaging"
      MESSAGING_PORT: "9092"
      KAFKA_BROKERS: "messaging:9093"
      KAFKA_TOPIC: "telemetry-raw"
    expose:
      - "1883"
    depends_on:
      messaging:
        condition: "service_started"
    networks:
      - "aspire"
  energy-simulator:
    image: "${ENERGY_SIMULATOR_IMAGE}"
    environment:
      OTEL_TRACES_EXPORTER: "otlp"
      OTEL_LOGS_EXPORTER: "otlp"
      OTEL_METRICS_EXPORTER: "otlp"
      OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED: "true"
      MQTT_BROKER_URL: "tcp://mqtt-bridge:1883"
      TENANT_ID: "T001"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://compose-dashboard:18889"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_SERVICE_NAME: "energy-simulator"
    depends_on:
      mqtt-bridge:
        condition: "service_started"
    networks:
      - "aspire"
  server:
    image: "${SERVER_IMAGE}"
    environment:
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EXCEPTION_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EVENT_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_RETRY: "in_memory"
      ASPNETCORE_FORWARDEDHEADERS_ENABLED: "true"
      HTTP_PORTS: "${SERVER_PORT}"
      ConnectionStrings__app-db: "Host=postgresql;Port=5432;Username=postgres;Password=${POSTGRESQL_PASSWORD};Database=app-db"
      APP_DB_HOST: "postgresql"
      APP_DB_PORT: "5432"
      APP_DB_USERNAME: "postgres"
      APP_DB_PASSWORD: "${POSTGRESQL_PASSWORD}"
      APP_DB_URI: "postgresql://postgres:${POSTGRESQL_PASSWORD}@postgresql:5432/app-db"
      APP_DB_JDBCCONNECTIONSTRING: "jdbc:postgresql://postgresql:5432/app-db"
      APP_DB_DATABASENAME: "app-db"
      ConnectionStrings__telemetry-db: "Host=postgresql;Port=5432;Username=postgres;Password=${POSTGRESQL_PASSWORD};Database=telemetry-db"
      TELEMETRY_DB_HOST: "postgresql"
      TELEMETRY_DB_PORT: "5432"
      TELEMETRY_DB_USERNAME: "postgres"
      TELEMETRY_DB_PASSWORD: "${POSTGRESQL_PASSWORD}"
      TELEMETRY_DB_URI: "postgresql://postgres:${POSTGRESQL_PASSWORD}@postgresql:5432/telemetry-db"
      TELEMETRY_DB_JDBCCONNECTIONSTRING: "jdbc:postgresql://postgresql:5432/telemetry-db"
      TELEMETRY_DB_DATABASENAME: "telemetry-db"
      Jwt__Key: "${JWT_KEY}"
      Jwt__Issuer: "emma-identity"
      Jwt__Audience: "emma-api"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://compose-dashboard:18889"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_SERVICE_NAME: "server"
    ports:
      - "${SERVER_PORT}"
    depends_on:
      postgresql:
        condition: "service_started"
    networks:
      - "aspire"
  market-service:
    image: "${MARKET_SERVICE_IMAGE}"
    environment:
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EXCEPTION_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EVENT_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_RETRY: "in_memory"
      ConnectionStrings__messaging: "messaging:9092"
      MESSAGING_HOST: "messaging"
      MESSAGING_PORT: "9092"
      ConnectionStrings__telemetry-db: "Host=postgresql;Port=5432;Username=postgres;Password=${POSTGRESQL_PASSWORD};Database=telemetry-db"
      TELEMETRY_DB_HOST: "postgresql"
      TELEMETRY_DB_PORT: "5432"
      TELEMETRY_DB_USERNAME: "postgres"
      TELEMETRY_DB_PASSWORD: "${POSTGRESQL_PASSWORD}"
      TELEMETRY_DB_URI: "postgresql://postgres:${POSTGRESQL_PASSWORD}@postgresql:5432/telemetry-db"
      TELEMETRY_DB_JDBCCONNECTIONSTRING: "jdbc:postgresql://postgresql:5432/telemetry-db"
      TELEMETRY_DB_DATABASENAME: "telemetry-db"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://compose-dashboard:18889"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_SERVICE_NAME: "market-service"
    depends_on:
      messaging:
        condition: "service_started"
      server:
        condition: "service_started"
    networks:
      - "aspire"
  ingestion:
    image: "${INGESTION_IMAGE}"
    environment:
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EXCEPTION_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EVENT_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_RETRY: "in_memory"
      ConnectionStrings__app-db: "Host=postgresql;Port=5432;Username=postgres;Password=${POSTGRESQL_PASSWORD};Database=app-db"
      APP_DB_HOST: "postgresql"
      APP_DB_PORT: "5432"
      APP_DB_USERNAME: "postgres"
      APP_DB_PASSWORD: "${POSTGRESQL_PASSWORD}"
      APP_DB_URI: "postgresql://postgres:${POSTGRESQL_PASSWORD}@postgresql:5432/app-db"
      APP_DB_JDBCCONNECTIONSTRING: "jdbc:postgresql://postgresql:5432/app-db"
      APP_DB_DATABASENAME: "app-db"
      ConnectionStrings__telemetry-db: "Host=postgresql;Port=5432;Username=postgres;Password=${POSTGRESQL_PASSWORD};Database=telemetry-db"
      TELEMETRY_DB_HOST: "postgresql"
      TELEMETRY_DB_PORT: "5432"
      TELEMETRY_DB_USERNAME: "postgres"
      TELEMETRY_DB_PASSWORD: "${POSTGRESQL_PASSWORD}"
      TELEMETRY_DB_URI: "postgresql://postgres:${POSTGRESQL_PASSWORD}@postgresql:5432/telemetry-db"
      TELEMETRY_DB_JDBCCONNECTIONSTRING: "jdbc:postgresql://postgresql:5432/telemetry-db"
      TELEMETRY_DB_DATABASENAME: "telemetry-db"
      ConnectionStrings__messaging: "messaging:9092"
      MESSAGING_HOST: "messaging"
      MESSAGING_PORT: "9092"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://compose-dashboard:18889"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_SERVICE_NAME: "ingestion"
    depends_on:
      postgresql:
        condition: "service_started"
      messaging:
        condition: "service_started"
      server:
        condition: "service_started"
    networks:
      - "aspire"
  emma-identity:
    image: "${EMMA_IDENTITY_IMAGE}"
    environment:
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EXCEPTION_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EVENT_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_RETRY: "in_memory"
      ASPNETCORE_FORWARDEDHEADERS_ENABLED: "true"
      HTTP_PORTS: "${EMMA_IDENTITY_PORT}"
      ConnectionStrings__identity-db: "Host=postgresql;Port=5432;Username=postgres;Password=${POSTGRESQL_PASSWORD};Database=identity-db"
      IDENTITY_DB_HOST: "postgresql"
      IDENTITY_DB_PORT: "5432"
      IDENTITY_DB_USERNAME: "postgres"
      IDENTITY_DB_PASSWORD: "${POSTGRESQL_PASSWORD}"
      IDENTITY_DB_URI: "postgresql://postgres:${POSTGRESQL_PASSWORD}@postgresql:5432/identity-db"
      IDENTITY_DB_JDBCCONNECTIONSTRING: "jdbc:postgresql://postgresql:5432/identity-db"
      IDENTITY_DB_DATABASENAME: "identity-db"
      Jwt__Key: "${JWT_KEY}"
      Jwt__Issuer: "emma-identity"
      Jwt__Audience: "emma-api"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://compose-dashboard:18889"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_SERVICE_NAME: "emma-identity"
    expose:
      - "${EMMA_IDENTITY_PORT}"
    depends_on:
      postgresql:
        condition: "service_started"
    networks:
      - "aspire"
  webfrontend:
    image: "${WEBFRONTEND_IMAGE}"
    environment:
      NODE_ENV: "production"
      PORT: "8000"
      SERVER_HTTP: "http://server:${SERVER_PORT}"
      services__server__http__0: "http://server:${SERVER_PORT}"
      SERVER_HTTPS: "https://server:${SERVER_PORT}"
      EMMA_IDENTITY_HTTP: "http://emma-identity:${EMMA_IDENTITY_PORT}"
      services__emma-identity__http__0: "http://emma-identity:${EMMA_IDENTITY_PORT}"
      EMMA_IDENTITY_HTTPS: "https://emma-identity:${EMMA_IDENTITY_PORT}"
      IDENTITY_HTTP: "http://emma-identity:${EMMA_IDENTITY_PORT}"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://compose-dashboard:18889"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_SERVICE_NAME: "webfrontend"
    expose:
      - "8000"
    depends_on:
      server:
        condition: "service_started"
    networks:
      - "aspire"
  command-service:
    image: "${COMMAND_SERVICE_IMAGE}"
    environment:
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EXCEPTION_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EVENT_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_RETRY: "in_memory"
      ConnectionStrings__messaging: "messaging:9092"
      MESSAGING_HOST: "messaging"
      MESSAGING_PORT: "9092"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://compose-dashboard:18889"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_SERVICE_NAME: "command-service"
    depends_on:
      messaging:
        condition: "service_started"
    networks:
      - "aspire"
  emma-api:
    image: "${EMMA_API_IMAGE}"
    environment:
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EXCEPTION_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EVENT_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_RETRY: "in_memory"
      ASPNETCORE_FORWARDEDHEADERS_ENABLED: "true"
      HTTP_PORTS: "${EMMA_API_PORT}"
      ConnectionStrings__app-db: "Host=postgresql;Port=5432;Username=postgres;Password=${POSTGRESQL_PASSWORD};Database=app-db"
      APP_DB_HOST: "postgresql"
      APP_DB_PORT: "5432"
      APP_DB_USERNAME: "postgres"
      APP_DB_PASSWORD: "${POSTGRESQL_PASSWORD}"
      APP_DB_URI: "postgresql://postgres:${POSTGRESQL_PASSWORD}@postgresql:5432/app-db"
      APP_DB_JDBCCONNECTIONSTRING: "jdbc:postgresql://postgresql:5432/app-db"
      APP_DB_DATABASENAME: "app-db"
      ConnectionStrings__telemetry-db: "Host=postgresql;Port=5432;Username=postgres;Password=${POSTGRESQL_PASSWORD};Database=telemetry-db"
      TELEMETRY_DB_HOST: "postgresql"
      TELEMETRY_DB_PORT: "5432"
      TELEMETRY_DB_USERNAME: "postgres"
      TELEMETRY_DB_PASSWORD: "${POSTGRESQL_PASSWORD}"
      TELEMETRY_DB_URI: "postgresql://postgres:${POSTGRESQL_PASSWORD}@postgresql:5432/telemetry-db"
      TELEMETRY_DB_JDBCCONNECTIONSTRING: "jdbc:postgresql://postgresql:5432/telemetry-db"
      TELEMETRY_DB_DATABASENAME: "telemetry-db"
      ConnectionStrings__identity-db: "Host=postgresql;Port=5432;Username=postgres;Password=${POSTGRESQL_PASSWORD};Database=identity-db"
      IDENTITY_DB_HOST: "postgresql"
      IDENTITY_DB_PORT: "5432"
      IDENTITY_DB_USERNAME: "postgres"
      IDENTITY_DB_PASSWORD: "${POSTGRESQL_PASSWORD}"
      IDENTITY_DB_URI: "postgresql://postgres:${POSTGRESQL_PASSWORD}@postgresql:5432/identity-db"
      IDENTITY_DB_JDBCCONNECTIONSTRING: "jdbc:postgresql://postgresql:5432/identity-db"
      IDENTITY_DB_DATABASENAME: "identity-db"
      ConnectionStrings__messaging: "messaging:9092"
      MESSAGING_HOST: "messaging"
      MESSAGING_PORT: "9092"
      Jwt__Key: "${JWT_KEY}"
      Jwt__Issuer: "emma-identity"
      Jwt__Audience: "emma-api"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://compose-dashboard:18889"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_SERVICE_NAME: "emma-api"
    expose:
      - "${EMMA_API_PORT}"
    depends_on:
      postgresql:
        condition: "service_started"
    networks:
      - "aspire"
  solar-forecaster:
    image: "${SOLAR_FORECASTER_IMAGE}"
    environment:
      OTEL_TRACES_EXPORTER: "otlp"
      OTEL_LOGS_EXPORTER: "otlp"
      OTEL_METRICS_EXPORTER: "otlp"
      OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED: "true"
      ConnectionStrings__telemetry-db: "Host=postgresql;Port=5432;Username=postgres;Password=${POSTGRESQL_PASSWORD};Database=telemetry-db"
      TELEMETRY_DB_HOST: "postgresql"
      TELEMETRY_DB_PORT: "5432"
      TELEMETRY_DB_USERNAME: "postgres"
      TELEMETRY_DB_PASSWORD: "${POSTGRESQL_PASSWORD}"
      TELEMETRY_DB_URI: "postgresql://postgres:${POSTGRESQL_PASSWORD}@postgresql:5432/telemetry-db"
      TELEMETRY_DB_JDBCCONNECTIONSTRING: "jdbc:postgresql://postgresql:5432/telemetry-db"
      TELEMETRY_DB_DATABASENAME: "telemetry-db"
      ConnectionStrings__messaging: "messaging:9092"
      MESSAGING_HOST: "messaging"
      MESSAGING_PORT: "9092"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://compose-dashboard:18889"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_SERVICE_NAME: "solar-forecaster"
    depends_on:
      postgresql:
        condition: "service_started"
    networks:
      - "aspire"
  optimizer:
    image: "${OPTIMIZER_IMAGE}"
    environment:
      OTEL_TRACES_EXPORTER: "otlp"
      OTEL_LOGS_EXPORTER: "otlp"
      OTEL_METRICS_EXPORTER: "otlp"
      OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED: "true"
      ConnectionStrings__telemetry-db: "Host=postgresql;Port=5432;Username=postgres;Password=${POSTGRESQL_PASSWORD};Database=telemetry-db"
      TELEMETRY_DB_HOST: "postgresql"
      TELEMETRY_DB_PORT: "5432"
      TELEMETRY_DB_USERNAME: "postgres"
      TELEMETRY_DB_PASSWORD: "${POSTGRESQL_PASSWORD}"
      TELEMETRY_DB_URI: "postgresql://postgres:${POSTGRESQL_PASSWORD}@postgresql:5432/telemetry-db"
      TELEMETRY_DB_JDBCCONNECTIONSTRING: "jdbc:postgresql://postgresql:5432/telemetry-db"
      TELEMETRY_DB_DATABASENAME: "telemetry-db"
      ConnectionStrings__messaging: "messaging:9092"
      MESSAGING_HOST: "messaging"
      MESSAGING_PORT: "9092"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://compose-dashboard:18889"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_SERVICE_NAME: "optimizer"
    depends_on:
      postgresql:
        condition: "service_started"
      solar-forecaster:
        condition: "service_started"
    networks:
      - "aspire"
networks:
  aspire:
    driver: "bridge"
